AWSTemplateFormatVersion: 2010-09-09
Description: CloudRIG

Parameters:
  InstanceSpotMaximumPrice:
    Type: String
    Description: The maximum spot price for your CloudRIG instance

  InstanceSize:
    Type: String
    Default: g3s.xlarge
    AllowedValues: ["g2.2xlarge", "g3s.xlarge", "g3.4xlarge"]
    Description: The instance size that CloudRIG is running

  InstanceAMIId:
    Type: AWS::EC2::Image::Id
    Description: The AMI Id to use for the CloudRIG instance

  InstanceRootEBSType:
    Type: String
    Default: gp2
    AllowedValues:
      - gp2
      - io1
      - sc1
      - st1
      - standard
    Description: The EBS type for the CloudRIG instance

  InstanceAddAdditionalEBS:
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
    Description: Determine if we the instance should have an additional disk

  InstanceAdditionalEBSType:
    Type: String
    Default: gp2
    AllowedValues:
      - gp2
      - io1
      - sc1
      - st1
      - standard
    Description: The EBS type for the CloudRIG instance

  InstanceAdditionalEBSSize:
    Type: String
    Default: 100
    Description: The EBS size (in Gb) for the CloudRIG instance

  InstanceKeyPairName:
    # We don't use the AWS::EC2::KeyPair::KeyName type to allow it to be empty
    Type: String
    Default: ''
    Description: (Optionnal) The KeyPair associated to the CloudRIG instance. Leave empty if you don't want to use a KeyPair.

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The VPC Id where is the CloudRIG instance is going to be deployed

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: The Subnet ids where the CloudRIG instance can be deployed

  SecurityGroupIngressCIDR:
    Type: String
    Description: The CIDR allowed to connect to the CloudRIG instance
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'

  ParsecHostingStartPort:
    Type: String
    Default: 8000
    Description: The Parsec hosting start port (usually 8000)

  ParsecHostingEndPort:
    Type: String
    Default: 8003
    Description: The Parsec hosting end port (usually 8003)

  ParsecServerKey:
    Type: String
    NoEcho: true
    Description: The Parsec server key

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Instance Configuration"
        Parameters:
          - InstanceSize
          - InstanceAMIId
          - InstanceSpotMaximumPrice
          - InstanceKeyPairName
      - Label:
          default: "Storage Configuration"
        Parameters:
          - InstanceRootEBSType
          - InstanceAddAdditionalEBS
          - InstanceAdditionalEBSType
          - InstanceAdditionalEBSSize
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcId
          - SubnetIds
          - SecurityGroupIngressCIDR
      - Label:
          default: "Parsec Configuration"
        Parameters:
          - ParsecHostingStartPort
          - ParsecHostingEndPort
          - ParsecServerKey

Conditions:
  ShouldUseAKeyPair: !Not [ !Equals [ !Ref InstanceKeyPairName, "" ]]
  ShouldDeployAnAdditionalDisk: !Equals [ !Ref InstanceAddAdditionalEBS, "" ]
  IsInstanceSupportsEphemeralDisks: !Equals [ !Ref InstanceSize, "g2.2xlarge" ]

Mappings:
  CloudRIGStaticConfiguration:
    Versionning:
      LambdaCodeVersion: 1.0

Resources:


  #
  #
  #   EC2 INSTANCE CREATION AND CONFIGURATION
  #
  #

  CloudRIGInstanceProfileRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM'
      Policies:
        - PolicyName: cloudrig-role-delete-tags-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: 'ec2:DeleteTags'
                Resource: 'arn:aws:ec2:*:*:instance/*'
                Condition:
                  StringEquals:
                    'ec2:ResourceTag/cloudrig': 'true'

  CloudRIGInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref CloudRIGInstanceProfileRole

  CloudRIGInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: cloudrig-security-group
      GroupDescription: CloudRIG Security group
      SecurityGroupIngress:
        - CidrIp: !Ref SecurityGroupIngressCIDR
          Description: Allow ingress to Parsec
          IpProtocol: tcp
          FromPort: !Ref ParsecHostingStartPort
          ToPort: !Ref ParsecHostingEndPort
      VpcId: !Ref VpcId

  #
  #
  #   SPOT FLEET
  #
  #

  CloudRIGSpotFleetIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - spotfleet.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: cloudrig-spotfleet-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                - 'ec2:*'
                - 'iam:ListRoles'
                - 'iam:ListInstanceProfiles'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'iam:PassRole'
                Resource: !GetAtt CloudRIGInstanceProfileRole.Arn

  CloudRIGSpotFleet:
    Type: AWS::EC2::SpotFleet
    Properties:
      SpotFleetRequestConfigData:
        AllocationStrategy: lowestPrice
        IamFleetRole: !GetAtt CloudRIGSpotFleetIamRole.Arn
        InstanceInterruptionBehavior: stop
        LaunchSpecifications:
          - BlockDeviceMappings:
            - DeviceName: '/dev/sda1'
              Ebs:
                VolumeType: !Ref InstanceRootEBSType
            - !If
              - ShouldDeployAnAdditionalDisk
              - DeviceName: '/dev/sdb1'
                Ebs:
                  VolumeSize: !Ref InstanceAdditionalEBSSize
                  VolumeType: !Ref InstanceAdditionalEBSType
              - !Ref AWS::NoValue
            - !If
              - IsInstanceSupportsEphemeralDisks
              - DeviceName: '/dev/xvdca'
                VirtualName: 'ephemeral0'
              - !Ref AWS::NoValue
            InstanceType: !Ref InstanceSize
            ImageId: !Ref InstanceAMIId
            IamInstanceProfile:
              Arn: !GetAtt CloudRIGInstanceProfile.Arn
            KeyName: !If [ShouldUseAKeyPair, !Ref InstanceKeyPairName, !Ref "AWS::NoValue"]
            SubnetId: !Join [',', !Ref SubnetIds]
            SecurityGroups:
            - GroupId: !GetAtt CloudRIGInstanceSecurityGroup.GroupId
            UserData:
              "Fn::Base64": !Sub network_server_start_port=8000:app_host=1:server_key=${ParsecServerKey}:app_check_user_data=1
        SpotPrice: !Ref InstanceSpotMaximumPrice
        Type: maintain
        TargetCapacity: 0

  #
  #
  #  SAVING STATE LAMBDAS
  #
  #

  CloudRIGSaveStateLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: cloudrig-lambda-save-state
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ec2:DescribeSpotFleetInstances'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'iam:PassRole'
                Resource: !GetAtt CloudRIGAutomationIamRole.Arn
              - Effect: Allow
                Action:
                  - 'ssm:StartAutomationExecution'
                Resource: '*'
        - PolicyName: cloudrig-lambda-ami-created
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'cloudformation:DescribeStacks'
                  - 'ec2:DescribeImages'
                Resource: '*'
              - Effect: Allow
                Action: 'ec2:CreateTags'
                Resource:
                  - 'arn:aws:ec2:*::image/*'
                  - 'arn:aws:ec2:*::snapshot/*'
              - Effect: Allow
                Action: 'cloudformation:UpdateStack'
                Resource: !Ref 'AWS::StackId'
              - Effect: Allow
                Action:
                  - 'ssm:StartAutomationExecution'
                Resource: '*'
          - PolicyName: cloudrig-lambda-update-ami-in-stack
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Sid: AllowToCreateTheChangeSet
                  Effect: Allow
                  Action:
                    - "iam:GetRole"
                    - "iam:GetInstanceProfile"
                    - "iam:GetPolicy"
                    - "iam:GetRolePolicy"
                    - "ec2:DescribeVpcs"
                    - "ec2:DescribeSubnets"
                    - "ec2:DescribeSpotFleetRequests"
                  Resources: '*'
                - Sid: AllowToPassTheInstanceProfileRole
                  Effect: Allow
                  Action:
                    - "iam:PassRole"
                  Resources:
                    - !GetAtt CloudRIGInstanceProfileRole.Arn
                    - !GetAtt CloudRIGSpotFleetIamRole.Arn
                - Sid: AllowToUpdateTheSpotFleet
                  Effect: Allow
                  Action:
                    - "ec2:RequestSpotFleet"
                    - "ec2:CancelSpotFleetRequests"
                    - "ec2:CreateTags"
                    - "ec2:RunInstances"
                  Resources: '*'
                - Sid: AllowToUpdateTheSSMAutomation
                  Effect: Allow
                  Action:
                    - "ssm:CreateDocument"
                    - "ssm:DescribeDocument"
                    - "ssm:DeleteDocument"
                    - "ssm:AddTagsToResource"
                - Sid: AllowToUpdateEnvironmentVariable
                  Effect: Allow
                  Action:
                    - "lambda:UpdateFunctionConfiguration"
                  Resources: !GetAtt CloudRIGSaveStateLambda.Arn


  CloudRIGSaveStateLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: CloudRIG Save state lambda
      Handler: "lambda-save-state.handler"
      MemorySize: 128
      Role: !GetAtt CloudRIGSaveStateLambdaExecutionRole.Arn
      Runtime: "python3.7"
      Timeout: 30
      Environment:
        Variables:
          CLOUDRIG_SPOTFLEET_REQUEST_ID: !Ref CloudRIGSpotFleet
          CLOUDRIG_SAVE_STATE_AUTOMATION_DOCUMENT_NAME: !Ref CloudRIGSaveStateSSMAutomation
      Code:
        S3Bucket: !Sub "cloudrig-lambda-code-${AWS::Region}"
        S3Key: !Join
          - "/"
          - - "cloudrig"
            - !FindInMap [CloudRIGStaticConfiguration, Versionning, LambdaCodeVersion]
            - "cloudrig-lambda-code.zip"

  CloudRIGSaveStateLambdaInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CloudRIGSaveStateLambda
      Action: 'lambda:InvokeFunction'
      Principal: events.amazonaws.com
      SourceAccount: !Ref 'AWS::AccountId'
      SourceArn: !GetAtt CloudRIGCloudWatchRuleInstanceStoppingWatcher.Arn

  CloudRIGAMICreatedLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: CloudRIG AMI Created handler
      Handler: "lambda-ami-created.handler"
      MemorySize: 128
      Role: !GetAtt CloudRIGSaveStateLambdaExecutionRole.Arn
      Runtime: "python3.7"
      Timeout: 180
      Environment:
        Variables:
          CLOUDRIG_CLOUDFORMATION_STACK_NAME: !Ref AWS::StackName
      Code:
        S3Bucket: !Sub "cloudrig-lambda-code-${AWS::Region}"
        S3Key: !Join
        - "/"
        - - "cloudrig"
          - !FindInMap [CloudRIGStaticConfiguration, Versionning, LambdaCodeVersion]
          - "cloudrig-lambda-code.zip"

  CloudRIGCloudWatchRuleInstanceStoppingWatcher:
    Type: AWS::Events::Rule
    Properties:
      Description: Watch if the instance is stopped and create the
      EventPattern: {
        "source": [
          "aws.ec2"
        ],
        "detail-type": [
          "EC2 Instance State-change Notification"
        ],
        "detail": {
          "state": [
            "stopped"
          ]
        }
      }
      State: ENABLED
      Targets:
        - Id: "TriggerSaveStateLambda"
          Arn: !GetAtt CloudRIGSaveStateLambda.Arn

#
#
#   SSM RESOURCES
#
#

  CloudRIGAutomationIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ssm.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: cloudrig-ssm-automation-save-state
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ec2:CreateImage'
                  - 'ec2:DescribeImages'
                  - 'ec2:TerminateInstances'
                  - 'ec2:ModifySpotFleetRequest'
                Resource: '*'
              - Effect: Allow
                Action: 'lambda:InvokeFunction'
                Resource: '*'

  CloudRIGSaveStateSSMAutomation:
    Type: 'AWS::SSM::Document'
    Properties:
      DocumentType: Automation
      Tags:
        - Key: "cloudrig"
          Value: "true"
      Content:
        description: CloudRIG Save state on instance stopped
        schemaVersion: '0.3'
        assumeRole: !GetAtt CloudRIGAutomationIamRole.Arn
        parameters:
          InstanceId:
            type: String
            description: (Required) The InstanceId

        mainSteps:
          # Create the AMI from the stopped instance
          - name: CreateImageFromStoppedInstance
            action: 'aws:executeAwsApi'
            inputs:
              Service: ec2
              Api: CreateImage
              Name: 'cloudrig-{{global:DATE_TIME}}'
              InstanceId: '{{ InstanceId }}'
            outputs:
              - Name: ImageId
                Selector: '$.ImageId'
                Type: String

          # Scale down the SpotFleet request
          - name: ScaleDownTheSpotFleetRequest
            action: 'aws:executeAwsApi'
            inputs:
              Service: ec2
              Api: ModifySpotFleetRequest
              SpotFleetRequestId: !Ref CloudRIGSpotFleet
              TargetCapacity: 0

          # Then terminate the instance
          - name: TerminateInstance
            action: 'aws:executeAwsApi'
            inputs:
              Service: ec2
              Api: TerminateInstances
              InstanceIds:
                - '{{ InstanceId }}'

          # Wait for the AMI to be ready
          - name: WaitForImageCreated
            action: 'aws:waitForAwsResourceProperty'
            inputs:
              Service: ec2
              Api: DescribeImages
              ImageIds:
                - '{{ CreateImageFromStoppedInstance.ImageId }}'
              PropertySelector: '$.Images[0].State'
              DesiredValues:
                - "available"
                - "invalid"
                - "deregistered"
                - "transient"
                - "failed"
                - "error"
            outputs:
              - Name: ImageState
                Selector: '$.Images[0].State'
                Type: String

          # Handle the image creation
          - name: RunLambdaHandleAMICreation
            action: 'aws:invokeLambdaFunction'
            maxAttempts: 3
            timeoutSeconds: 60
            isEnd: true
            inputs:
              FunctionName: !Ref CloudRIGAMICreatedLambda
              Payload: '{"AccountId": "{{ global:ACCOUNT_ID }}", "ImageId": "{{ CreateImageFromStoppedInstance.ImageId }}"}'

Outputs:
  CloudRIGSpotFleetId:
    Description: The CloudRIG SpotFleet Id used to run the CloudRIG instance
    Value: !Ref CloudRIGSpotFleet
